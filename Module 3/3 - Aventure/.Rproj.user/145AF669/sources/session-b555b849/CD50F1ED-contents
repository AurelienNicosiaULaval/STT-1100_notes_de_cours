---
title: "Aventure 3 - Infractions dans les restaurants de MontrÃ©al"
subtitle: "STT-1100 Introduction Ã  la science des donnÃ©es"
author: 
  - institute: "UniversitÃ© Laval"
editor: visual
editor_options: 
  chunk_output_type: console
format:
  html:
    toc: true
    toc-title: Plan
    css: [../../css/base_css.css]
    self-contained: true
#    number-sections: true
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(UlavalSSD)
```

# ğŸ¬ Mise en situationÂ : Devenez *data journalist*

Vous Ãªtes engagÃ©s comme **journaliste de donnÃ©es** par *Le Courrier Gourmand*, un mÃ©dia local fictif qui publie des enquÃªtes interactives sur lâ€™alimentation Ã  MontrÃ©al.Â Votre rÃ©dactrice en chef souhaite un article Ã©clairant le public sur **les infractions alimentaires commises dans les restaurants montrÃ©alais**Â . Elle vous donne quelques pistes de reflexion:

-   Quelle est la proportion des Ã©tablissements provenant de la ville de MontrÃ©al?

-   Quelles sont les infractions les plus courantesâ€¯?

-   Quels types dâ€™Ã©tablissements sont touchÃ©sâ€¯?

-   Quel montant dâ€™amendes ont Ã©tÃ© imposÃ©es en moyenneâ€¯? Ce montant dÃ©pend t-il du type d'infractions?

Ã€ la fin de lâ€™aventure, vous devrez remettre **un article Quarto** (HTML) rÃ©pondant Ã  ces questions et illustrÃ© de graphiques construits dans R.

::: callout-note
**Votre alliÃ© municipal**\
Voici **Alexandre Durand**, conseiller municipal chargÃ© de lâ€™hygiÃ¨ne alimentaire Ã  la Ville de MontrÃ©al. Il suit votre enquÃªte pas Ã  pas et vous posera, Ã  des moments clÃ©s, des questions pour aiguiller vos analyses. C'est un alliÃ© prÃ©cieux pour la rÃ©daction de votre article, mais il a aussi ses exigences. Il attend de vous que vous lui fournissiez des rÃ©ponses claires et prÃ©cises, accompagnÃ©es de graphiques pertinents.
:::

## Objectifs de lâ€™aventure

-   Importer et nettoyer un jeu de donnÃ©es catÃ©gorielles rÃ©elles (infractions alimentaires).
-   Construire des tableaux de frÃ©quence, des statistiques descriptives et des visualitions
-   RÃ©diger un court billet journalistique reproductible dans Quarto.

::: note
ğŸ’¡ **Note pour le rapport**\
Tout au long de l'analyse, vous devrez garder en tÃªte ces questions et y rÃ©pondre de maniÃ¨re argumentÃ©e dans votre rapport `qmd`
:::

Dans ce module, vous explorerez un **jeu de donnÃ©es** qui dÃ©crit diverses infractions, leurs amendes et le type dâ€™Ã©tablissements concernÃ©s. Votre missionâ€¯: **analyser les donnÃ©es pour rÃ©pondre Ã  lâ€™objectif dâ€™identifier les infractions dans les restaurants Ã  MontrÃ©al**.

------------------------------------------------------------------------

# ğŸ¯ Comment rÃ©ussir l'aventure

1.  **Charger les donnÃ©es** : Vous pouvez soit :
    -   Charger le package `UlavalSSD` et appeler `data(listecondamnation)`.
2.  **Suivre les sections** : Chaque section contient des explications, une dÃ©monstration, des expÃ©rimentations Ã  rÃ©aliser, puis des exercices.
3.  **Documenter vos trouvailles** : Comme dans les aventures prÃ©cÃ©dentes, commentez votre code, expliquez vos choix et validez vos analyses. Vos trouvailles vont vous aider a faire votre article de journal.

------------------------------------------------------------------------

# ğŸš€ Travail sur Github

Avant de commencer l'analyse des donnÃ©es, vous devez rÃ©cupÃ©rer le dÃ©pÃ´t GitHub contenant les fichiers nÃ©cessaires.

1ï¸âƒ£ Clonez le dÃ©pÃ´t "Aventure-3-IDENTIFIANT_GITHUB", pour cela crÃ©ez un nouveau projet Rstudio et copier coller le lien HTTPS de votre repo Github (voir feuille aide mÃ©moire).

ğŸ’¡ Astuce : Si vous souhaitez revenir plus tard sur ce projet, vous pouvez ouvrir directement le projet en double-cliquant sur le fichier `.Rproj` dans votre explorateur de fichiers.

2ï¸âƒ£ Ajuster le fichier Quarto: Le modÃ¨le de l'article de journal est prÃ©sent dans le dÃ©pÃ´t. Allez inscrire votre nom.

3ï¸âƒ£ Premier commit et push vers GitHub: Une fois votre fichier `.qmd` ajustÃ© et enregistrÃ©, commitez et poussez vos modifications sur GitHub :

Attention: on se rappelle que les messages de commit doivent Ãªtre parlant. Par exemple "Ajout de mon nom dans l'article"

ğŸ¯ FÃ©licitations ! Vous Ãªtes maintenant prÃªt Ã  dÃ©buter lâ€™analyse ! ğŸš€

# ğŸ·ï¸ Variables catÃ©goriques : les bases en R avec `stringr`

## âœ¨ Explications

En R, une variable catÃ©gorique est souvent reprÃ©sentÃ©e par :

-   Un **facteur** (`factor`) qui contient un ensemble de niveaux dÃ©finis.

-   Ou un simple **character** pour les chaÃ®nes de caractÃ¨res.

**Dans le Tidyverse**, on manipule souvent des chaÃ®nes de caractÃ¨res via le package **stringr**â€¯; pour la conversion en facteur, on peut utiliser `as.factor()` ou le package **forcats**.

Pour le module 3, nous nous concentrerons sur les variables catÃ©gorique de type **character**. Dans le module 4, nous verrons plus en dÃ©tail les facteurs.

Voici des exemples dÃ©montrant comment utiliser `stringr` (partie du `Tidyverse`) pour manipuler des variables de type character dans un jeu de donnÃ©es comme `listecondamnation`. Les exemples ciâ€‘dessous ciblent des cas frÃ©quentsâ€¯: dÃ©tection de motifs, extraction, remplacement, et nettoyage de chaÃ®nes.

## ğŸš€ DÃ©monstration

On va utiliser le jeu de donnÃ©es `listecondamnation` de la librarie `UlavalSSD` qui contient les condamnations des Ã©tablissements alimentaires au QuÃ©bec.

```{r}
library(UlavalSSD)
library(tidyverse)
glimpse(listecondamnation)
```

> **Remarque** : Lancer `glimpse()` sur vos donnÃ©es vous permettra de repÃ©rer quelles colonnes sont en `chr` (character) et lesquelles sont en `factor` ou encore en `numeric`.

> **Remarque 2** : Trois colonnes sont au format date, pour l'instant, nous n'en tiendrons pas compte, nous reviendrons dans un module plus tard sur le format date.

::: callout-tip
#### Exercice

Quel est le type de la variable `Amende`? Est-ce que cela vous semble problÃ©matique?
:::

> Cette information sera pertiennete pour le nettoyage de la variable `Amende` dans la section suivante, vous pourrez ainsi le documenter dans la section MÃ©thodologie de l'article.

::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Question dâ€™Alexandre"}

*Â«â€¯Combien de constats dâ€™infraction apparaissent dans le fichier brutâ€¯?â€¯Â»*

:::

::: {.callout-caution collapse="true" title="âœ… RÃ©ponse d'Alexandre"}
**RÃ©ponse possible**Â : Utilisez `nrow(listecondamnation)` aprÃ¨s lâ€™importâ€¯; on obtient par exemple **1 712** lignes.

Alexandre vous rappelle que `?listecondamnation` vous donne la documentation du jeu de donnÃ©es.
:::

### DÃ©tection de motifs (`str_detect()`)

Pour vÃ©rifier si lâ€™adresse mentionne `"MONTREAL"` (ou un code postal, etc.), on peut faire :

```{r}

# CrÃ©er une colonne boolÃ©enne 'est_montreal'
listecondamnation <- listecondamnation %>%
  mutate(est_montreal = str_detect(Adresse_lieu_infraction, "MONTREAL"))

# AperÃ§u
listecondamnation %>%
  select(Adresse_lieu_infraction, est_montreal) %>%
  head(10)
```

Vous obtenez `TRUE/FALSE` selon la prÃ©sence du mot **MONTREAL** dans la chaÃ®ne.

::: callout-tip
#### Exercice

Quelle est la proportion du nombre d'adresse contenant le mot **MONTREAL**?
:::

::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Message dâ€™Alexandre"}
**Message dâ€™Alexandre**Â : *Â«â€¯C'est un fait trÃ¨s intÃ©ressant Ã  mettre dans ton article!Â»*
:::

### Remplacement (`str_replace()` et `str_replace_all()`)

Pour nettoyer la colonne `Amende`, on peut enlever le symbole `$` ou remplacer des virgules par des points, etc.

```{r}

# str_replace() remplace la 1re occurrence ; str_replace_all() toutes les occurrences  
listecondamnation <- listecondamnation %>%   mutate( 
  # Exemple : retirer le $ si prÃ©sent 
  Amende_clean = str_replace_all(Amende, "\\$", ""), 
  # remplacer Ã©ventuelles virgules par un point   
  Amende_clean = str_replace_all(Amende_clean, ",", ".")   )  

# VÃ©rifions 
listecondamnation %>%  
  select(Amende, Amende_clean) %>%  
  head(10)
```

Ici, les motifs sont des **expressions rÃ©guliÃ¨res**.

-   `\\$` correspond littÃ©ralement au signe `$`.

-   `,` est remplacÃ© par `.` (utile si votre texte comporte `\"1,000\"`).

::: callout-tip
#### Exercice

Quelle est le type de la variable `Amende_clean`? Est-ce un problÃ¨me?
:::

::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Message dâ€™Alexandre"}
*Â«â€¯Pas si simple d'avoir la colonne Amende en numÃ©rique!Â»*
:::

### Extraction de motifs (`str_extract()`)

Pour extraire un Ã©lÃ©ment prÃ©cis. Par exemple, si `Adresse_lieu_infraction` contient un code postal de la forme `H2X 3E4`, on peut tenter :

```{r}

listecondamnation <- listecondamnation %>%   
  mutate(     
    code_postal = str_extract(Adresse_lieu_infraction, "[A-Z][0-9][A-Z]\\s*[0-9][A-Z][0-9]")   )  

listecondamnation %>%  
  select(Adresse_lieu_infraction, code_postal) %>%
  head(10)
```

Le motif `[A-Z][0-9][A-Z]\\s*[0-9][A-Z][0-9]` est une forme simplifiÃ©e dâ€™un code postal canadien.

::: callout-tip
#### Exercice

Tous les codes postaux qui commencent par H2X correspondent Ã  des adresses dans la Quartie Ville-Marie Ã  MontrÃ©al.

Combien d'Ã©tablissements du quartie de Ville-Marie ont recu une comdannation?
:::


:::{.callout-important title="ğŸ§‘â€ğŸ’¼ - Message dâ€™Alexandre"}
*Â«â€¯Nous avons toujours mentionnÃ© que moins de 1% des Ã©tablissements en infractions de MontrÃ©al proviennent de Ville-Marie! Est-ce vraiment vrai?Â»*

Un bel ajout Ã  ton article!
:::


### Mise en forme (`str_to_lower()`, `str_to_upper()`, etc.)

Parfois, il est utile dâ€™harmoniser la casse (`MONTREAL`, `MontrÃ©al`, etc.) :

```{r}
listecondamnation <- listecondamnation %>%  
  mutate(     Adresse_lower = str_to_lower(Adresse_lieu_infraction),    
              # ou str_to_upper, str_to_title ...   
              # trim pour enlever espaces en trop    
              Adresse_trim = str_trim(Adresse_lieu_infraction)   )
```

### Suppression dâ€™espaces multiples (`str_squish()`)

Si les donnÃ©es contiennent des espaces superflus :

```{r}
listecondamnation <- listecondamnation %>%   
  mutate(     
    Adresse_squish = str_squish(Adresse_lieu_infraction)  
    )
```

`str_squish()` rÃ©duit tous les espaces rÃ©pÃ©tÃ©s Ã  un seul et supprime ceux en dÃ©but/fin de chaÃ®ne.

::: callout-tip
#### Exercice

1.  **Filtrer MontrÃ©al** : CrÃ©ez un nouveau data frame `condamnation_mtl` ne contenant **que** les restaurants provenant de MontrÃ©al. On va utiliser ici le code postal, en effet, tous les codes postaux de MontrÃ©al commence par la lettre H.

> **Indication** : Vous pouvez utiliser `str_sub()` pour extraire la premiere lettre (ou caractÃ¨re) d'une chaÃ®ne de caractÃ¨res.

2.  **Recherche de mots-clÃ©s** :

-   DÃ©tectez le mot-clÃ© (â€œTEMPERATUREâ€) dans `SOC_NOM_ARTCL_INFRC`. CrÃ©ez une variable boolÃ©enne `est_temp`. Cela va nous permettre de voir quelles infractions sont reliÃ©es Ã  la tempÃ©rature.

-   Quel est la proportion d'infraction reliÃ©e Ã  la tempÃ©rature dans le sous-ensemble de MontrÃ©al?

3.  On termine le nettoyage de la colonne amende.

-   **Nettoyage complet de la variable `Amende`** : CrÃ©er une variable `Amende_num` qui est de type `numeric` avec le montant de l'amende payÃ© par le restaurant. Vous allez devoir utiliser le fonction `as.numeric`.

-   Quel est le type de la variable `Amende_num`? Est-ce un problÃ¨me?

-   Quel est le montant d'amende moyen pour les infractions reliÃ©es Ã  la tempÃ©rature?
:::


::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Question dâ€™Alexandre"}
*Â«â€¯La colonne `SOC_NOM_ARTCL_INFRC` donne la classification de l'infraction. Combien de type d'infractions diffÃ©rentes avons nous en lien avec la tempÃ©ratureâ€¯Â»*

-   1

-   2

-   3

-   4

-   5

-   6 
:::


:::{.callout-caution collapse="true" title="âœ… RÃ©ponse d'Alexandre"}
**RÃ©ponse possible**Â : Utilisez `unique()` pour compter le nombre de types dâ€™infractions. Par exemple, `length(unique(listecondamnation$SOC_NOM_ARTCL_INFRC))` vous donnera le nombre total de types dâ€™infractions.

Maintenant on peut faire la mÃªme chose mais pour les infractions reliÃ©es Ã  la tempÃ©rature avec `listecondamnation %>% filter(est_temp == TRUE) %>% unique()`

Et on en compte 5:

```{r echo=FALSE}
listecondamnation %>% 
  mutate(est_temp = str_detect(SOC_NOM_ARTCL_INFRC, "TEMPERATURE")) %>%
  filter(est_temp == TRUE) %>%
  select(SOC_NOM_ARTCL_INFRC) %>% 
  unique() 
```
:::

Pensez Ã  gÃ©nÃ©rer votre rapport, committer vos modifications et pousser sur GitHub pour garder une trace de votre travail ! ğŸš€

::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Remarque dâ€™Alexandre"}
On a travailler sur les infractions reliÃ©es Ã  la tempÃ©rature, mais il y a d'autres types d'infraction. Est-ce que vous pouvez en trouver une qui vous inquiÃ¨te? Par exemple, les insectes, les rongeurs ou l'insalubritÃ©!

Je crois que ca peut faire un bel ajout de rÃ©sultat clÃ© Ã  mettre dans ton article ğŸ˜‰ 
:::
------------------------------------------------------------------------

# ğŸ— Statistiques descriptives pour variables catÃ©goriques

Dans cette section, nous allons dÃ©couvrir comment rÃ©sumer lâ€™information contenue dans les variables qualitatives, appelÃ©es aussi catÃ©gorielles. Nous verrons comment compter les occurrences de chaque catÃ©gorie (tableaux de frÃ©quences), calculer des proportions (ou pourcentages) afin de mieux visualiser la rÃ©partition, et associer plusieurs variables pour mieux comprendre leurs interactions (tableaux de contingence). Lâ€™objectif est de disposer dâ€™un portrait clair de la distribution des catÃ©gories pour en tirer des conclusions rapides sur les tendances ou anomalies prÃ©sentes dans les donnÃ©es.

## âœ¨ Explications

Les **tableaux de frÃ©quences** et les **mesures de tendance** (nombre dâ€™observations, pourcentages) sont un bon point de dÃ©part pour rÃ©sumer des variables catÃ©goriques.

## ğŸš€ DÃ©monstration

```{r}
# Nombre d'infractions par type dâ€™Ã©tablissement

listecondamnation %>%
  count(Type_etablissement) %>%
  arrange(desc(n))
```

> **Astuce** : `count()` + `arrange(desc(n))` vous permet de classer les catÃ©gories par ordre dâ€™occurrence.

::: callout-tip
#### Exercice

1.  **Proportions** : Calculez la proportion de chaque type dâ€™Ã©tablissement (ex. `count(Type_etablissement) %>% mutate(prop = n / sum(n))`).

2.  **Amende moyenne** : AprÃ¨s avoir extrait la valeur numÃ©rique de la colonne `Amende` de l'exercice de la section prÃ©cÃ©dente, regroupez par `Type_etablissement` et calculez la moyenne de lâ€™amende (`mean(Amende_num)`).

3.  **Infractions sur lâ€™ensemble du QuÃ©bec** : Comparez la distribution entre â€œMontrÃ©alâ€ (filtrÃ©e prÃ©cÃ©demment) et le reste. Quelle catÃ©gorie dâ€™Ã©tablissements semble la plus concernÃ©eâ€¯?
:::

::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Remarque dâ€™Alexandre"}
On a toujours pensÃ© que MontrÃ©al n'Ã©tait pas le pire endroit pour les infractions alimentaires peut importe le type de restaurant. Est-ce que vous pouvez le prouver avec vos rÃ©sultats?
:::

Un tableau de contingence (ou tableau croisÃ©) est un tableau qui prÃ©sente simultanÃ©ment la rÃ©partition de deux (ou plusieurs) variables catÃ©goriques, permettant ainsi de repÃ©rer des liens ou des tendances entre elles. Par exemple, pour croiser le type dâ€™Ã©tablissement et la nature de lâ€™infraction dans votre jeu de donnÃ©esâ€¯:

```{r eval=FALSE}
table(
  listecondamnation$Type_etablissement,
  listecondamnation$SOC_NOM_ARTCL_INFRC
)

```


::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Question dâ€™Alexandre"}
 Y a-t-il plus de restaurants qui ont eu une amende pour `INSECTES RONGEURS EXCREMENTS` ou de Rest. service rapide qui ont eu une amende pour `INSALUBRITE`?
:::

:::{.callout-caution collapse="true" title="âœ… RÃ©ponse d'Alexandre"}

On peut facile trouver l'information en allant la chercher directemement dans le tableau croisÃ©:

```{r}
tab <- table(
  listecondamnation$Type_etablissement,
  listecondamnation$SOC_NOM_ARTCL_INFRC
)

tab["RESTAURANT SERVICE RAPIDE", "INSALUBRITE"]

tab["RESTAURANT", "INSECTES RONGEURS EXCREMENTS"]
```
:::

On va terminer cette section avec un exercice qui vous permettra de vous familiariser avec les tableaux de contingence et les statistiques descriptives, mais surtout permettre a la ville de verifier si leur codification de l'infraction est bonne. 

::: callout-tip
#### Exercice

1.  **Tableeau de contingence** : Construisez un tableau croisÃ© entre `Type_etablissement` et la nature de lâ€™infraction (`SOC_NOM_ARTCL_INFRC`), dans votre sous-ensemble de MontrÃ©al.

2.  **RÃ©sumÃ© descriptif** : Dressez un petit tableau rÃ©capitulatif (type dâ€™Ã©tablissement, nombre total, amende moyenne).

3.  **CatÃ©gories rares** : DÃ©terminez si lâ€™une des variables catÃ©goriques (`SOC_NOM_ARTCL_INFRC` et `Type_etablissement`) a des catÃ©gories rare ou quasi inexploitÃ©e. Devrait-on la regrouperâ€¯?
:::

Pensez Ã  gÃ©nÃ©rer votre rapport, committer vos modifications et pousser sur GitHub pour garder une trace de votre travail ! ğŸš€

------------------------------------------------------------------------

# ğŸ“ˆ Visualisation de donnÃ©es catÃ©goriques

## âœ¨ Explications

Pour reprÃ©senter visuellement des variables catÃ©goriques, on utilise souvent :

-   **Diagrammes en barres** (`geom_bar()` ou `geom_col()`),

-   **Diagramme en tarte (Pie chart)** (moins recommandÃ©, sauf usage trÃ¨s simple),

-   **Graphique de mosaique (Mosaic plots)** si on veut comparer plusieurs catÃ©gories croisÃ©es.

## ğŸš€ DÃ©monstration

```{r }
library(ggplot2)

# Exemple : Nombre dâ€™infractions par type dâ€™Ã©tablissement
listecondamnation %>%
  ggplot(aes(x = Type_etablissement)) +
  geom_bar(fill = "steelblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # permet de rotationner les noms des labels sur l'axe des x
  labs(
    title = "Infractions par type dâ€™Ã©tablissement Ã  MontrÃ©al",
    x = "Type dâ€™Ã©tablissement",
    y = "Nombre d'infractions"
  )
```

> **IdÃ©e** : Appliquez un `coord_flip()` si les noms sont trop longs!


Interrogeonsâ€‘nous sur **la nature mÃªme des infractions**. ConnaÃ®tre les catÃ©gories dominantes et leur distribution dans les diffÃ©rents types dâ€™Ã©tablissements aidera Ã  formuler un message clair pour le grand public.

::: callout-tip
#### Exercice

1.  **Top 5** : Concentrez-vous sur les 5 catÃ©gories les plus frÃ©quentes de `SOC_NOM_ARTCL_INFRC` (via un tri ou `fct_lump()`).
2.  **Diagramme Ã  barre** : faites un diagramme Ã  barre selon `SOC_NOM_ARTCL_INFRC` et le type d'Ã©tablissement `Type_etablissement`.
3.  **Bonnes pratiques de visualisation** : Ajoutez un titre, des couleurs, modifiez le thÃ¨me ou lâ€™orientation de lâ€™axe pour un rendu plus clair.
:::

::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Remarque dâ€™Alexandre"}
_Â«â€¯Ce graphique doit parler au lecteur en un clin dâ€™Å“il. Assureâ€‘toi dâ€™indiquer que 5 catÃ©gories couvrent dÃ©jÃ  Xâ€¯% des infractionsâ€¯; câ€™est un message fort pour lâ€™introduction de ton article.â€¯Â»_
:::

Le **montant des amendes** est un indicateur concret qui attire souvent lâ€™attention du public et des mÃ©dias. Comparer ces montants entre MontrÃ©al et le reste du QuÃ©bec, et entre types dâ€™Ã©tablissements, permettra dâ€™appuyer votre conclusion.


::: callout-tip
#### Exercice

1.  **Boites Ã  moustaches** : ReprÃ©sentez (avec des boites Ã  moustache) la rÃ©partition ddu montant de l'amende au sein de chaque `Type_etablissement`.
2.  **Comparaison** : Comparez MontrÃ©al versus hors MontrÃ©al (deux boites Ã  moustaches cÃ´te Ã  cÃ´te, par type dâ€™Ã©tablissement). Que remarquez-vous?
3.  **Traitement de donnÃ©es manquantes** : Que faites-vous si `Amende` est manquante dans un sous-ensembleâ€¯? Explorez quelques pistes.
:::

::: {.callout-important title="ğŸ§‘â€ğŸ’¼ - Remarque dâ€™Alexandre"}
_Â«â€¯Pense Ã  citer un ou deux chiffres marquants dans ton texteÂ : par exemple, la mÃ©diane des amendes montrÃ©alaises versus hors MontrÃ©al. Ã‡a rendra tes conclusions plus percutantes.â€¯Â»_
:::

------------------------------------------------------------------------

# ğŸš€ 5. Aller plus loinÂ : cartographier les amendes (optionnel)

Pour clore lâ€™enquÃªte, **Alexandre** a mis la main sur un bout de code R rÃ©digÃ© par une collÃ¨gue de la Villeâ€¯; ce script gÃ©ocode automatiquement les codes postaux et fournit une latitude/longitude pour chaque Ã©tablissement. Vous allez lâ€™utiliser pour dresser **une carte de la rÃ©partition des amendes**.

```{r geocode-helper, echo=TRUE}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Fonction utilitaire : de code postal (ex. "H2X 3X2") vers lon/lat
# Utilise tidygeocoder + lâ€™API de gÃ©ocodage Nominatim (OpenStreetMap)
geocode_pc <- function(df, pc_col = "code_postal") {
  df %>%
     # 1) Nettoyer les codes postaux : enlever espaces, majuscules
    mutate(
      postal_tmp = str_remove_all(.data[[pc_col]], "\\s"),
      postal_tmp = str_to_upper(postal_tmp),
      # 2) RÃ©-insÃ©rer lâ€™espace si la chaÃ®ne fait prÃ©cisÃ©ment 6 caractÃ¨res
      postal_std = if_else(
        nchar(postal_tmp) == 6,
        str_replace(postal_tmp, "^(.{3})(.{3})$", "\\1 \\2"),
        postal_tmp
      )
    ) %>%
    tidygeocoder::geocode(address = postal_std, method = "osm",
                          lat = latitude, long = longitude,
                          timeout = 5) %>%
    select(-postal_tmp, -postal_std)   # on nettoie les colonnes temporaires
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

> **Remarque** : Vous devez installer le package `tidygeocoder` pour utiliser cette fonction. Vous pouvez le faire avec `install.packages("tidygeocoder")`.

::: {.callout-tip}
#### Exercice â€“ Carte des amendes

1. **GÃ©ocodage**Â : appliquez `geocode_pc()` Ã  votre jeu de donnÃ©es, en vous assurant de conserver `Amende`.  
2. **AgrÃ©gation**Â : calculez le **montant total dâ€™amendes par point gÃ©ocodÃ©** (p.Â ex. par restaurant ou par coordonnÃ©es arrondies au 4áµ‰ dÃ©cimal).  
3. **Carte statique**Â : utilisez `ggplot2 + geom_point()` sur un fond simple (`coord_sf()`)â€¯; la taille ou la couleur du point peut reflÃ©ter le montant cumulÃ©.  
:::

```{r solution-carte, message=FALSE, warning=FALSE, echo=FALSE, eval=FALSE}
library(viridis)
# 1. GÃ©ocodage (Ã©chantillon pour la dÃ©mo; retirez slice_head() dans le rendu final)
infractions_geo <- listecondamnation %>%
  mutate(Amende = as.numeric(Amende_clean)) %>%
  select(code_postal, amende = Amende) %>%
  filter(!is.na(code_postal), !is.na(amende)) %>%
  slice_head(n = 500) %>%
  geocode_pc(pc_col = "code_postal") %>%
  mutate(pc_round = paste0(round(latitude, 4), "_", round(longitude, 4)))

# 2. AgrÃ©gation par point gÃ©ocodÃ©
carte_pts <- infractions_geo %>%
  group_by(pc_round) %>%
  summarise(lat = mean(latitude), lon = mean(longitude),
            total_amende = sum(amende, na.rm = TRUE), .groups = "drop")

# 3. Carte statique
ggplot(carte_pts, aes(lon, lat)) +
  geom_point(aes(size = total_amende, colour = total_amende), alpha = 0.7) +
  scale_size_continuous(labels = scales::dollar_format()) +
  scale_colour_viridis_c(labels = scales::dollar_format()) +
  coord_sf(crs = 4326) +
  labs(title = "Montant cumulÃ© des amendes par Ã©tablissement (Ã©chantillon)",
       size = "Cumul $", colour = "Cumul $") +
  theme_void()
```

::: {.callout-important}
**Conseil dâ€™Alexandre**Â : _Â«â€¯Un visuel vaut mille mots. Choisis un **zoom sur le centreâ€‘ville** oÃ¹ la densitÃ© dâ€™amendes est la plus forte, et cite un chiffreâ€‘clÃ© (ex. 180â€¯000â€¯$ dâ€™amendes dans un rayon de 2â€¯km). Ton article gagnera en impact.â€¯Â»_
:::


------------------------------------------------------------------------

# ğŸ”š Conclusion de lâ€™aventure

Cette troisiÃ¨me aventure vous a permis de **passer du rÃ´le dâ€™analyste Ã  celui de journaliste de donnÃ©es**â€¯: vous avez nettoyÃ© un jeu rÃ©el dâ€™inspections alimentaires, quantifiÃ© les infractions majeures, comparÃ© les profils dâ€™Ã©tablissements et visualisÃ© la gÃ©ographie des amendes.  

Vous disposez maintenantâ€¯:

- dâ€™un **ensemble de rÃ©sultats chiffrÃ©s** (top 5 infractions, montants moyens, proportion MontrÃ©al vs horsâ€‘MontrÃ©al, ...etc.)â€¯;
- de **graphiques percutants** (diagrammes en barres, boÃ®tes Ã  moustaches, carte) pour Ã©tayer vos argumentsâ€¯;
- dâ€™**observations qualitatives** fournies par Alexandre, qui orientent le rÃ©cit vers les enjeux dâ€™hygiÃ¨ne et de transparence citoyenne.

## âœï¸ Prochaine Ã©tapeÂ : rÃ©digez votre article

1. **Structurez votre article Quarto**Â : chapeau accrocheur âœ contexte âœ mÃ©thodologie âœ rÃ©sultats clÃ©s âœ recommandations.  
2. **IntÃ©grez au moins deux visuels** parmi ceux produits (un graphique de catÃ©gories et la carte des amendes).  
3. **Citez deux chiffres narratifs** (ex. Â«â€¯5 catÃ©gories couvrent 62â€¯% des infractionsâ€¯Â», Â«â€¯180â€¯000â€¯$ dâ€™amendes dans un rayon de 2â€¯kmâ€¯Â») pour captiver le lecteur.  
4. **Ajoutez une citation synthÃ©tique dâ€™Alexandre** pour humaniser votre conclusion.

> **Livrable attendu**Â : un fichier HTML autonome exportÃ© depuis votre `.qmd`, commitÃ© sur votre dÃ©pÃ´t GitHub avant la date limite.

Bonne rÃ©dactionâ€¯! Faites parler les donnÃ©es et mettezâ€‘vous dans la peau du journaliste qui informe, nuance et propose. ğŸš€

> ğŸ¯ **FÃ©licitations**â€¯! Vous avez mis en pratique les concepts de variables catÃ©goriques, de statistiques descriptives et de visualisation pour des donnÃ©es catÃ©goriques rÃ©elles. Continuez ainsi, le prochain module vous attend.
