---
title: "Aventure 5 - Explorer et comprendre les relations entre les donnÃ©es"
subtitle: "STT-1100 Introduction Ã  la science des donnÃ©es"
author: 
  - institute: "UniversitÃ© Laval"
format: 
  html:
    toc: true
    toc-title: "Plan de lâ€™aventure"
    embed-resources: true
    link-external-newwindow: true
    code-link: true
    theme: flatly
    css: [../../css/base_css.css]
editor: visual
editor_options: 
  chunk_output_type: console
---

# ğŸ•¹ï¸ Mise en situation â€” Aventure 5

Tu enfiles les chaussures (et le badge sÃ©curisÃ© !) dâ€™unÂ·e **statisticienÂ·ne des opÃ©rations aÃ©roportuaires** fraÃ®chement recrutÃ©Â·e par la **Port Authority Data Lab (PADL)**, lâ€™Ã©quipe dâ€™analytique du **Port Authority of New York & New Jersey**.\
Ta mission : aider lâ€™aÃ©roport **JFK** (et, Ã  terme, **EWR** et **LGA**) Ã  fluidifier les dÃ©parts et Ã  rÃ©duire le **temps perdu au sol**.

-   **Ta coÃ©quipiÃ¨re** : **Dr Sofia MartÃ­nez**, data-scientist senior reconnue pour ses visualisations interactives percutantes. Sofia pose les bonnes questions, valide tes hypothÃ¨ses et tâ€™ouvre lâ€™accÃ¨s aux ressources internes.\
-   **Le jeu de donnÃ©es** : **Alex Chen**, data engineer au PADL, tâ€™a prÃ©parÃ© un fichier **`flights_merged_2023.rds`** qui regroupe en une seule table exhaustive les vols 2023, la mÃ©tÃ©o Ã  lâ€™heure de dÃ©part, les infos avion, les noms complets des compagnies et la gÃ©olocalisation des aÃ©roports dâ€™origine et de destination.\
-   **Contexte concret** : le Board des opÃ©rations veut savoir *quand* et *pourquoi* les retards explosent, comment la mÃ©tÃ©o influe sur les connexions, et quelles compagnies devraient revoir leur plan de vol. Tes livrables (rapports Quarto + visualisations) orienteront les dÃ©cisions budgÃ©taires pour lâ€™Ã©tÃ© 2026.

> ğŸ“ **Brief de Sofia**\
> 1. Quels crÃ©neaux horaires affichent systÃ©matiquement les retards les plus Ã©levÃ©s ?\
> 2. Quelle part des retards est imputable Ã  la mÃ©tÃ©o par rapport Ã  dâ€™autres facteurs ?\
> 3. Les avions plus Ã¢gÃ©s (\> 20 ans) sont-ils davantage sujets aux annulations ?
>
> Ã€ toi de jouer !

# ğŸ¯ Objectifs de lâ€™aventure

-   Utiliser les fonctions de `lubridate` pour manipuler et enrichir les donnÃ©es temporelles.
-   RÃ©aliser une analyse exploratoire des donnÃ©es (EDA) pour mieux comprendre leur structure et identifier des patterns intÃ©ressants.
-   Visualiser les relations entre variables Ã  lâ€™aide de `ggplot2`.
-   InterprÃ©ter des rÃ©sultats statistiques simples, comme la corrÃ©lation.
-   RÃ©pondre Ã  des questions concrÃ¨tes en lien avec des enjeux rÃ©els (retards, mÃ©tÃ©o, flotte dâ€™avions).

# âœ… Comment rÃ©ussir cette aventure ?

Voici quelques conseils de Sofia pour bien rÃ©ussir ta mission :

-   Commence par **explorer les donnÃ©es** et comprendre leur structure. Tu peux utiliser `glimpse()`, `summary()`, ou mÃªme un tableau interactif.
-   Utilise les fonctions de `lubridate` pour crÃ©er des colonnes temporelles utiles (jour, mois, heure, etc.).
-   Pour chaque question, **structure ton analyse** :
    -   explique ce que tu cherches Ã  tester ;
    -   montre ton code ;
    -   interprÃ¨te le rÃ©sultat.
-   PrivilÃ©gie des visualisations claires et bien annotÃ©es. Nâ€™oublie pas dâ€™ajouter des titres, axes, etc.
-   Commente ton code au besoin. Imagine que tu travailles en Ã©quipe avec Sofia !

Et surtoutâ€¦ **pose-toi des questions** ! Lâ€™important, câ€™est de dÃ©velopper ton raisonnement analytique.

# ğŸ§ª GitHub et rendu

Comme pour les aventures prÃ©cÃ©dentes :

-   **Clonez** le dÃ©pÃ´t GitHub du module 5 depuis lâ€™organisation du cours. Vous pouvez utiliser la cheat sheet du cours si vous avez un trou de mÃ©moire.

-   Travaillez dans RStudio et **faites des commits rÃ©guliÃ¨rement** pour documenter votre avancement.

-   Votre dÃ©pÃ´t doit contenir :

-   un fichier **`rapport.qmd`** bien structurÃ© contenant :

    -    votre code R ;

    -   des visualisations commentÃ©es ;

    -   des interprÃ©tations claires pour chaque analyse demandÃ©e ;

    -   des encadrÃ©s `callout` (type `.tip`, `.warning`, etc.) pour faire ressortir vos conclusions ;

    -   un fichier **`rapport.html`** gÃ©nÃ©rÃ© Ã  partir du `.qmd` (vous pouvez utiliser le bouton "Render" dans RStudio) ;

    -   tous les fichiers nÃ©cessaires Ã  la reproduction de votre travail (ex. : script de prÃ©paration, jeu de donnÃ©es `flights_merged_2023.rds`, etc.).

-   Le dÃ©pÃ´t doit rester **propre et bien organisÃ©** :

    -   ne conservez pas les fichiers inutiles ;
    -   Ã©vitez les noms de fichiers comme `Untitled1.Rmd` ou `copie rapport final.qmd` ğŸ˜Š ;
    -   commentez vos commits avec des messages clairs et descriptifs.

> ğŸ“Œ **Rappel** : Le `.qmd` est votre document principal. Il doit permettre Ã  nâ€™importe quelÂ·le membre de lâ€™Ã©quipe (ou Ã  Sofia !) de comprendre ce que vous avez fait et pourquoi.

# ğŸ“… Comprendre et manipuler les dates avec `lubridate`

Avant de plonger dans les analyses de retard et de performance, Sofia souhaite sâ€™assurer que tu maÃ®trises bien la gestion des **dates et heures** en R. Le package `lubridate` est un outil incontournable pour cela.

## ğŸ§° FonctionnalitÃ©s essentielles

Voici les principales fonctions que tu utiliserasâ€¯:

| Fonction | UtilitÃ© |
|----------------------------------------------|--------------------------|
| `make_date()` | CrÃ©e une variable de type `Date` Ã  partir de `year`, `month`, `day` |
| `make_datetime()` | CrÃ©e un objet temporel complet (`POSIXct`) avec `hour` |
| `wday()` | Donne le jour de la semaine |
| `month()` | Donne le mois |
| `hour()` | Extrait l'heure |
| `ymd()` | Transforme une chaÃ®ne comme `"2023-01-01"` en `Date` |
| `floor_date()` | Tronque une date Ã  la journÃ©e, semaine, mois, etc. |

``` r
# Exemple de crÃ©ation de date et datetime
flights <- flights %>%
  mutate(
    date = make_date(year, month, day),
    datetime = make_datetime(year, month, day, hour)
  )
```

## â“ Exercice 1 â€” Quelle est la structure de la date ?

::: callout-question
**Sofia te demande** : *CrÃ©e une variable `date` Ã  partir des colonnes `year`, `month` et `day`, puis utilise `class()` pour vÃ©rifier le type de cette nouvelle variable.*
:::

::: {.callout-tip collapse="true"}
**RÃ©ponse de Sofia**\
Tu peux utiliser :

``` r
flights <- flights %>% mutate(date = make_date(year, month, day))
class(flights$date)
```

Le type attendu est `"Date"`. Tu peux dÃ©sormais manipuler cette variable avec toutes les fonctions temporelles !
:::

## â“ Exercice 2 â€” Jour de la semaine

::: callout-question
**Sofia te demande** : *Ajoute une colonne `jour_semaine` qui donne le jour de la semaine (lundi, mardi, etc.) pour chaque vol. Affiche les 7 premiers rÃ©sultats.*
:::

::: {.callout-tip collapse="true"}
**RÃ©ponse de Sofia**\
Voici une faÃ§on de faire :

``` r
flights <- flights %>%
  mutate(jour_semaine = wday(date, label = TRUE, abbr = FALSE))

head(flights$jour_semaine, 7)
```

Cela utilise `label = TRUE` pour obtenir le nom complet (et non un chiffre).
:::

## â“ Exercice 3 â€” CrÃ©neau horaire

::: callout-question
**Sofia te demande** : *CrÃ©e une variable `moment_journee` qui classe les vols en "nuit", "matin", "aprÃ¨s-midi" ou "soir" selon l'heure prÃ©vue de dÃ©part.*
:::

::: {.callout-tip collapse="true"}
**RÃ©ponse de Sofia**\
Voici une suggestion :

``` r
flights <- flights %>%
  mutate(moment_journee = case_when(
    hour < 6  ~ "nuit",
    hour < 12 ~ "matin",
    hour < 18 ~ "aprÃ¨s-midi",
    TRUE      ~ "soir"
  ))
```

Tu peux ensuite explorer les retards selon ces crÃ©neaux temporels.
:::

## â“ Exercice 4 â€” Est-ce un week-endâ€¯?

::: callout-question
**Sofia te demande** : *Ajoute une variable logique `weekend` qui vaut `TRUE` si le vol a lieu un samedi ou un dimanche.*
:::

::: {.callout-tip collapse="true"}
**RÃ©ponse de Sofia**\
Utilise :

``` r
flights <- flights %>%
  mutate(weekend = jour_semaine %in% c("samedi", "dimanche"))
```

Nâ€™oublie pas que `jour_semaine` est une variable factor avec labels.
:::

# ğŸ” Explorer et comprendre les relations entre les donnÃ©es

Maintenant que tu es Ã  lâ€™aise avec les dates et les heures, Sofia souhaite tâ€™introduire Ã  une Ã©tape clÃ© de tout projet en science des donnÃ©es : **lâ€™analyse exploratoire des donnÃ©es**, souvent abrÃ©gÃ©e en **EDA** (*Exploratory Data Analysis*).

Lâ€™objectif est simple : **comprendre la structure des donnÃ©es, repÃ©rer des patterns, des anomalies, ou des corrÃ©lations intÃ©ressantes entre les variables**.

## ğŸ› ï¸ Outils Ã  ta disposition

Tu peux tâ€™appuyer sur :

-   **Statistiques descriptives** : `summary()`, `mean()`, `median()`, `sd()`, `n_distinct()`, etc.
-   **Visualisation** avec `ggplot2` :
    -   `geom_histogram()` ou `geom_density()` pour les distributions
    -   `geom_point()` pour visualiser des relations entre deux variables numÃ©riques
    -   `geom_boxplot()` pour comparer une variable numÃ©rique selon une variable catÃ©gorique
    -   `geom_bar()` pour des variables catÃ©goriques
-   **Tableaux croisÃ©s** avec `count()`, `group_by()` + `summarise()`
-   **CorrÃ©lations** avec `cor()` ou `ggcorrplot::ggcorrplot()` pour une matrice graphique

Sofia te propose maintenant d'examiner des **questions concrÃ¨tes** liÃ©es Ã  la performance des vols et aux retards. Tu devras analyser les donnÃ©es pour proposer une interprÃ©tation claire.

------------------------------------------------------------------------

## â“ Analyse 1 â€” Ã€ quelle heure faut-il Ã©viter de partir ?

::: callout-note
**Contexte** : Le gestionnaire des opÃ©rations de JFK a observÃ© que les retards semblent plus frÃ©quents Ã  certaines heures de la journÃ©e. Il souhaite valider sâ€™il existe des **crÃ©neaux critiques** Ã  Ã©viter pour les dÃ©parts.
:::

::: callout-question
**Sofia te demande** : *Fais une analyse pour identifier les heures de la journÃ©e oÃ¹ les retards au dÃ©part (`dep_delay`) sont les plus Ã©levÃ©s en moyenne. Visualise cette relation avec un graphique clair.*
:::

::: {.callout-tip collapse="true"}
**RÃ©ponse de Sofia**\
Tu peux regrouper les vols par heure et calculer la moyenne des retards :

``` r
flights %>%
  group_by(hour) %>%
  summarise(moyenne_retard = mean(dep_delay, na.rm = TRUE)) %>%
  ggplot(aes(x = hour, y = moyenne_retard)) +
  geom_col(fill = "steelblue") +
  labs(title = "Retard moyen au dÃ©part selon l'heure",
       x = "Heure prÃ©vue de dÃ©part",
       y = "Retard moyen (minutes)")
```

Attention : ne te laisse pas piÃ©ger par les heures tardives avec peu de vols !
:::

## â“ Analyse 2 â€” La mÃ©tÃ©o est-elle vraiment la coupable ?

::: callout-note
**Contexte** : Certains gestionnaires accusent systÃ©matiquement la mÃ©tÃ©o pour les retards. Sofia te propose de tester cette **hypothÃ¨se** Ã  lâ€™aide des donnÃ©es mÃ©tÃ©o jointes aux vols.
:::

::: callout-question
**Sofia te demande** : *Choisis une ou deux variables mÃ©tÃ©o (ex : `wind_gust`, `visib`, `precip`) et examine leur relation avec les retards (`dep_delay`).*
:::

Avant de plonger dans les visualisations, un petit dÃ©tour par un concept clÃ© : la **corrÃ©lation**.

### ğŸ“ˆ Quâ€™est-ce que la corrÃ©lation ?

La corrÃ©lation mesure la **force et la direction dâ€™une relation linÃ©aire** entre deux variables numÃ©riques. Sa valeur est comprise entre :

-   **-1** : corrÃ©lation parfaitement **nÃ©gative** (quand lâ€™une augmente, lâ€™autre diminue),
-   **0** : **aucune relation linÃ©aire** dÃ©tectÃ©e,
-   **+1** : corrÃ©lation parfaitement **positive** (les deux variables augmentent ensemble).

ğŸ’¡ Par exemple, si les rafales de vent (`wind_gust`) augmentent et que les retards aussi, on devrait observer une **corrÃ©lation positive**.

------------------------------------------------------------------------

### ğŸ§ª Ã‰tape 1 â€” Calculer la corrÃ©lation

``` r
flights %>%
  select(dep_delay, wind_gust, visib, precip) %>%
  cor(use = "complete.obs") %>%
  round(2)
```

Ce tableau te donne un aperÃ§u rapide de la force de la relation entre les retards (`dep_delay`) et certaines variables mÃ©tÃ©o.

### ğŸ§ª Ã‰tape 2 â€” Visualiser une relation

Un graphique de dispersion permet de **voir** la tendance entre deux variables. Tu peux par exemple tester :

``` r
ggplot(flights, aes(x = wind_gust, y = dep_delay)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Relation entre les rafales de vent et le retard au dÃ©part",
       x = "Rafales de vent (mph)",
       y = "Retard au dÃ©part (min)")
```

Le nuage de points te montre la tendance globale, et la ligne rouge correspond Ã  une **rÃ©gression linÃ©aire** (c'est Ã  dire la "meilleure" droite qui reprÃ©sente le lien linÃ©aire entre les deux variables) qui estime cette relation.

::: {.callout-tip collapse="true"}
**RÃ©ponse de Sofia**\
Tu peux aussi tester avec d'autres variables comme `visib` (visibilitÃ©) ou `precip` (prÃ©cipitations), et observer si les retards sont plus Ã©levÃ©s lorsque la mÃ©tÃ©o est mauvaise.

Attention :

-   Les corrÃ©lations ne prouvent pas de lien de **causalitÃ©** !

-   Certains retards mÃ©tÃ©o sont **indirects** (ex: en provenance dâ€™un autre aÃ©roport).
:::

## â“ Analyse 3 â€” Les vieux avions sont-ils moins fiables ?

::: callout-note
**Contexte** : L'Ã©quipe maintenance sâ€™interroge : les avions les plus Ã¢gÃ©s sont-ils plus souvent en retard ou annulÃ©s ? L'information sur lâ€™annÃ©e de fabrication est disponible dans `plane_year`.
:::

::: callout-question
**Sofia te demande** : *Analyse la relation entre lâ€™Ã¢ge de lâ€™avion et les retards ou annulations (`is.na(dep_time)`).*
:::

::: {.callout-tip collapse="true"}
**RÃ©ponse de Sofia**\
Tu peux crÃ©er une variable `age_avion` :

``` r
flights <- flights %>%
  mutate(age_avion = 2023 - plane_year)
```

Puis comparer :

``` r
flights %>%
  filter(!is.na(age_avion)) %>%
  group_by(age_avion) %>%
  summarise(p_annulation = mean(is.na(dep_time)),
            retard_moyen = mean(dep_delay, na.rm = TRUE)) %>%
  ggplot(aes(x = age_avion, y = retard_moyen)) +
  geom_line() +
  labs(title = "Retard moyen selon lâ€™Ã¢ge de lâ€™avion",
       x = "Ã‚ge de lâ€™avion (annÃ©es)", y = "Retard moyen (minutes)")
```

Tu peux aussi faire un `geom_bar()` pour le taux dâ€™annulation par tranche dâ€™Ã¢ge.
:::
